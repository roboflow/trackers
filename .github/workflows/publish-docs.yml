name: Docs/Build and Publish

on:
  push:
    branches: [main, 'release/*']
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to deploy'
        required: false
        default: 'main'
  release:
    types: [published]

# Ensure only one concurrent deployment
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# Restrict permissions by default
permissions:
  contents: write # Required for committing to gh-pages
  pages: write # Required for deploying to Pages
  pull-requests: write # Required for PR comments

jobs:
  docs-build-deploy:
    name: Publish Docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: ğŸ Install uv and set Python
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          python-version: "3.10"
          activate-environment: true

      - name: ğŸ—ï¸ Install dependencies
        run: uv sync --frozen --group docs

      - name: âš™ï¸ Configure git for github-actions
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: ğŸš€ Deploy Development Docs
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: uv run mike deploy --push preview

      - name: ğŸš€ Deploy Custom Ref Docs
        if: github.event_name == 'workflow_dispatch'
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REF_NAME="${{ github.event.inputs.ref }}"
          # If it's a full ref like refs/heads/branch or refs/tags/tag, extract the name
          CLEAN_REF=$(echo "$REF_NAME" | sed 's|^refs/[^/]*/||')
          uv run mike deploy --push $CLEAN_REF

      - name: ğŸš€ Deploy Release Docs
        if: github.event_name == 'release' && github.event.action == 'published'
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
          uv run mike deploy --push --update-aliases $latest_tag latest
          uv run mike set-default --push latest
