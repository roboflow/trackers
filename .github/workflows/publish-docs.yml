name: Build and Publish Docs

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to deploy'
        required: false
        default: 'main'
  release:
    types: [published]

# Ensure only one concurrent deployment
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# Restrict permissions by default
permissions:
  contents: write # Required for committing to gh-pages
  pages: write # Required for deploying to Pages
  pull-requests: write # Required for PR comments

jobs:
  deploy:
    name: Publish Docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: ğŸ Install uv and set Python
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          python-version: "3.10"
          activate-environment: true

      - name: ğŸ—ï¸ Install dependencies
        run: uv pip install -r pyproject.toml --group docs

      - name: âš™ï¸ Configure git for github-actions
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: ğŸš€ Deploy Development Docs
        if: (github.event_name == 'push' && github.ref == 'refs/heads/develop')
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: uv run mike deploy --push develop

      - name: ğŸš€ Deploy Custom Ref Docs
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.ref != 'develop'
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REF_NAME="${{ github.event.inputs.ref }}"
          # If it's a full ref like refs/heads/branch or refs/tags/tag, extract the name
          CLEAN_REF=$(echo $REF_NAME | sed 's|refs/.*/||')
          uv run mike deploy --push $CLEAN_REF

      - name: ğŸš€ Deploy Release Docs
        if: github.event_name == 'release' && github.event.action == 'published'
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
          uv run mike deploy --push --update-aliases $latest_tag latest
